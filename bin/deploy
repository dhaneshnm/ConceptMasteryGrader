#!/bin/bash
# Production deployment script for Concept Mastery Grader
set -e

echo "ğŸš€ Starting Concept Mastery Grader production deployment..."

# Check if required environment variables are set
required_vars=(
    "DATABASE_URL"
    "REDIS_URL" 
    "SECRET_KEY_BASE"
    "RAILS_MASTER_KEY"
    "OPENAI_API_KEY"
)

for var in "${required_vars[@]}"; do
    if [ -z "${!var}" ]; then
        echo "âŒ Error: Required environment variable $var is not set"
        exit 1
    fi
done

echo "âœ… Environment variables validated"

# Install dependencies
echo "ğŸ“¦ Installing dependencies..."
bundle install --deployment --without development test
npm ci --only=production

# Setup database
echo "ğŸ—„ï¸ Setting up database..."
bundle exec rails db:prepare RAILS_ENV=production
bundle exec rails db:migrate RAILS_ENV=production

# Precompile assets
echo "ğŸ¨ Precompiling assets..."
bundle exec rails assets:precompile RAILS_ENV=production

# Run security check
echo "ğŸ”’ Running security checks..."
if command -v brakeman &> /dev/null; then
    bundle exec brakeman -q --no-pager
else
    echo "âš ï¸  Brakeman not installed, skipping security scan"
fi

# Verify configuration
echo "ğŸ”§ Verifying configuration..."
bundle exec rails runner "Rails.application.eager_load!" RAILS_ENV=production

echo "âœ… Deployment preparation completed successfully!"

# Start services based on process type
case "${PROCESS_TYPE:-web}" in
    "web")
        echo "ğŸŒ Starting web server..."
        exec bundle exec rails server -b 0.0.0.0 -p ${PORT:-3000} -e production
        ;;
    "worker")
        echo "âš™ï¸ Starting background worker..."
        exec bundle exec sidekiq -c ${SIDEKIQ_CONCURRENCY:-5}
        ;;
    "release")
        echo "ğŸ”„ Running release tasks..."
        bundle exec rails db:migrate RAILS_ENV=production
        echo "Release tasks completed"
        ;;
    *)
        echo "âŒ Unknown process type: ${PROCESS_TYPE}"
        exit 1
        ;;
esac